<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PromptAgent</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold text-blue-700 mb-4">PromptAgent</h1>

    <div id="usageCounter" class="text-sm font-medium text-right text-gray-600 mb-2 hidden"></div>

    <button id="subscribeBtn" class="mt-4 bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700 w-full">
      🔐 Subscribe to PromptAgent Pro
    </button>

    <button id="dailyPostBtn" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 w-full">
      📅 Generate Today’s Daily Post
    </button>

    <div id="regenerateSection" class="hidden mt-4">
      <label class="block text-sm font-medium mb-1">Tweak the response (optional)</label>
      <input id="regenerateTweak" class="w-full p-2 border rounded mb-2" placeholder="Add details, change tone, etc..." />
      <button id="regenerateBtn" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 w-full">🔁 Regenerate</button>
    </div>

    <label class="block mb-2 font-semibold">Select Prompt Template</label>
    <select id="category" class="w-full p-2 border rounded mb-4">
      <option disabled selected>Loading templates...</option>
    </select>

    <label class="block mb-2 font-semibold">Select Tone</label>
    <select id="tone" class="w-full p-2 border rounded mb-4">
      <option value="">Default (Neutral)</option>
      <option value="Casual">😎 Casual</option>
      <option value="Persuasive">🧲 Persuasive</option>
      <option value="Professional">💼 Professional</option>
    </select>

    <label class="block mb-2 font-semibold">Your Input</label>
    <div class="flex items-start gap-2 mb-4">
      <textarea id="input" class="w-full p-2 border rounded h-24" placeholder="Type your prompt or click 🎙 to speak..."></textarea>
      <button id="voiceBtn" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded" title="Click to speak">🎙️</button>
    </div>

    <button id="generateBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">Generate</button>

    <div id="loadingSpinner" class="hidden mt-2 text-blue-600 text-sm animate-pulse">
      Generating, please wait...
    </div>

    <button onclick="resetUsage()" class="mt-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 w-full">🔄 Reset Usage (Dev Only)</button>

    <h2 class="mt-6 font-bold">AI Response</h2>
    <pre id="output" class="whitespace-pre-wrap bg-gray-200 p-4 rounded mt-2 text-sm"></pre>
    <a href="/library" class="text-blue-500 underline text-sm mt-4 inline-block">📚 View Saved Library</a>
    <button id="saveBtn" class="mt-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full">💾 Save to Library</button>
  </div>

<script>
let isProUser = false;
let lastPromptInput = "";
let lastCategory = "";
let lastTone = "";
let lastWasDailyPost = false;

fetch("/api/prompts")
  .then(res => res.json())
  .then(data => {
    const dropdown = document.getElementById("category");
    dropdown.innerHTML = "";
    data.forEach(template => {
      const option = document.createElement("option");
      option.value = template.id;
      option.textContent = template.label;
      dropdown.appendChild(option);
    });
  });

function updateUsageCounter(used, limit) {
  const counter = document.getElementById("usageCounter");
  if (used >= limit) {
    counter.innerHTML = `🚫 Prompt limit reached: <span id="usedCount">${used}</span> of ${limit}`;
  } else {
    counter.innerHTML = `Prompts used: <span id="usedCount">${used}</span> of ${limit}`;
  }
  counter.classList.remove("hidden");
  if (used >= limit) disableActions();
}

function reflectProStatus(isPro) {
  const counter = document.getElementById("usageCounter");
  if (isPro) {
    counter.innerHTML = "👑 Pro: <span class='text-green-700 font-bold'>Unlimited prompts</span>";
    counter.classList.remove("text-right", "text-gray-600", "hidden");
    counter.classList.add("text-green-600", "text-left");
  } else {
    counter.classList.remove("text-left", "text-green-600");
    counter.classList.add("text-right", "text-gray-600");
  }
}

function checkUserStatus() {
  fetch("/api/user-status")
    .then(res => res.json())
    .then(data => {
      isProUser = data.isPro;
      reflectProStatus(isProUser);
      if (!isProUser && data.usage) updateUsageCounter(data.usage.count, data.usage.limit);
      if (isProUser) {
        document.getElementById("generateBtn").disabled = false;
        document.getElementById("regenerateBtn").disabled = false;
        document.getElementById("dailyPostBtn").disabled = false;
        const upgradeBtn = document.getElementById("upgradeBtn");
        if (upgradeBtn) upgradeBtn.remove();
      }
    });
}
checkUserStatus();

function disableActions() {
  document.getElementById("generateBtn").disabled = true;
  document.getElementById("regenerateBtn").disabled = true;
  document.getElementById("dailyPostBtn").disabled = true;
  document.getElementById("output").textContent = "🚫 Prompt limit reached. Please upgrade to Pro.";
  if (!document.getElementById("upgradeBtn")) {
    const btn = document.createElement("button");
    btn.id = "upgradeBtn";
    btn.className = "mt-4 bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700 w-full";
    btn.textContent = "🔐 Upgrade to Pro";
    btn.onclick = () => document.getElementById("subscribeBtn").click();
    document.querySelector(".max-w-xl").appendChild(btn);
  }
}

function showRegenerate() {
  document.getElementById("regenerateSection").classList.remove("hidden");
}

document.getElementById("generateBtn").addEventListener("click", async () => {
  const input = document.getElementById("input").value;
  const category = document.getElementById("category").value;
  const tone = document.getElementById("tone").value;
  const spinner = document.getElementById("loadingSpinner");

  lastPromptInput = input;
  lastCategory = category;
  lastTone = tone;
  lastWasDailyPost = false;

  spinner.classList.remove("hidden");
  spinner.textContent = "Generating, please wait...";

  try {
    const response = await fetch("/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ input, category, tone })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || "Unknown error");

    document.getElementById("output").textContent = data.result;
    showRegenerate();

    if (data.usage && typeof data.usage.count === "number") {
      updateUsageCounter(data.usage.count, data.usage.limit);
      if (data.usage.count >= data.usage.limit) disableActions();
    }
  } catch (err) {
    document.getElementById("output").textContent = `❌ ${err.message}`;
  } finally {
    spinner.classList.add("hidden");
  }
});

document.getElementById("regenerateBtn").addEventListener("click", async () => {
  const tweak = document.getElementById("regenerateTweak").value.trim();
  const spinner = document.getElementById("loadingSpinner");
  spinner.classList.remove("hidden");
  spinner.textContent = "Tweaking response, please wait...";

  try {
    let data;
    if (lastWasDailyPost) {
      const response = await fetch("/daily-post", { method: "POST" });
      data = await response.json();
      if (!response.ok) throw new Error(data.error || "Unknown error");
    } else {
      const prompt = tweak ? `${lastPromptInput} ${tweak}` : lastPromptInput;
      const response = await fetch("/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ input: prompt, category: lastCategory, tone: lastTone })
      });
      data = await response.json();
      if (!response.ok) throw new Error(data.error || "Unknown error");

      if (data.usage && typeof data.usage.count === "number") {
        updateUsageCounter(data.usage.count, data.usage.limit);
        if (data.usage.count >= data.usage.limit) disableActions();
      }
    }
    document.getElementById("output").textContent = data.result;
  } catch (err) {
    document.getElementById("output").textContent = `❌ ${err.message}`;
  } finally {
    spinner.classList.add("hidden");
  }
});

document.getElementById("dailyPostBtn").addEventListener("click", async () => {
  const spinner = document.getElementById("loadingSpinner");
  spinner.classList.remove("hidden");
  spinner.textContent = "Generating today’s post...";

  try {
    const response = await fetch("/daily-post", { method: "POST" });
    const data = await response.json();
    if (!response.ok) throw new Error(data.error || "Unknown error");
    document.getElementById("output").textContent = data.result;
    lastWasDailyPost = true;
    showRegenerate();
  } catch (err) {
    document.getElementById("output").textContent = `❌ ${err.message}`;
  } finally {
    spinner.classList.add("hidden");
  }
});

document.getElementById("subscribeBtn").addEventListener("click", async () => {
  try {
    const response = await fetch("/subscribe", { method: "POST" });
    const data = await response.json();
    if (data.url) window.location.href = data.url;
    else alert("Stripe error: " + (data.error || "Unknown issue"));
  } catch (err) {
    alert("An error occurred. Please try again.");
  }
});

function resetUsage() {
  fetch('/reset-usage')
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      return fetch("/api/user-status");
    })
    .then(res => res.json())
    .then(data => {
      reflectProStatus(data.isPro);
      if (!data.isPro && data.usage) updateUsageCounter(data.usage.count, data.usage.limit);
      document.getElementById("generateBtn").disabled = false;
      document.getElementById("regenerateBtn").disabled = false;
      document.getElementById("dailyPostBtn").disabled = false;
      const upgradeBtn = document.getElementById("upgradeBtn");
      if (upgradeBtn) upgradeBtn.remove();
      document.getElementById("output").textContent = "";
    });
}
</script>
</body>
</html>

