<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Saved Library</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .editable:hover { background-color: #f0f0f0; cursor: pointer; }
    .folder-toggle:hover { cursor: pointer; text-decoration: underline; }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold text-blue-700 mb-4">üìö Saved Library</h1>
    <a href="/" class="text-blue-500 underline text-sm mb-4 inline-block">‚Üê Back to PromptAgent</a>

    <div class="flex flex-wrap gap-2 mb-4 items-center">
      <input id="searchLibrary" type="text" placeholder="Search posts..." class="border p-2 rounded w-full md:w-1/3">
      <select id="folderFilter" class="border p-2 rounded">
        <option value="">All Folders</option>
      </select>
      <select id="sortBy" class="border p-2 rounded">
        <option value="newest">Sort: Newest</option>
        <option value="oldest">Sort: Oldest</option>
        <option value="name">Sort: Name</option>
        <option value="favorite">Sort: Favorite</option>
      </select>
    </div>

    <div class="flex items-center gap-2 mb-6">
      <input type="text" id="newFolderInput" placeholder="New folder name..." class="border p-2 rounded w-full">
      <button id="createFolderBtn" class="bg-blue-500 text-white text-sm px-3 py-2 rounded">Create Folder</button>
      <button id="deleteFolderBtn" class="bg-red-500 text-white text-sm px-3 py-2 rounded">Delete Selected Folder</button>
    </div>

    <div id="libraryContainer" class="space-y-6"></div>

    <div class="text-center mt-6">
      <button id="clearLibrary" class="text-sm text-red-500 underline">Clear all saved items</button>
    </div>
  </div>

  <script>
    const container = document.getElementById("libraryContainer");
    const folderFilter = document.getElementById("folderFilter");
    const searchInput = document.getElementById("searchLibrary");
    const sortBy = document.getElementById("sortBy");
    const newFolderInput = document.getElementById("newFolderInput");
    const createFolderBtn = document.getElementById("createFolderBtn");

    let openFolders = new Set();

    function getFolders() {
      return JSON.parse(localStorage.getItem("folderList") || "[]");
    }

    function saveFolders(folders) {
      localStorage.setItem("folderList", JSON.stringify(folders));
    }

    function toggleSection(folderId) {
      document.querySelectorAll(".folder-section").forEach(sec => {
        const id = sec.dataset.folder;
        const items = sec.querySelector(".folder-items");
        if (id === folderId) {
          const isHidden = items.classList.toggle("hidden");
          if (!isHidden) openFolders.add(folderId);
          else openFolders.delete(folderId);
        } else {
          items.classList.add("hidden");
          openFolders.delete(id);
        }
      });
    }

    function loadLibrary() {
      const all = JSON.parse(localStorage.getItem("library") || "[]");
      const folders = [...new Set([...getFolders(), "Uncategorized", "Favorites"])]
        .filter(f => f !== "")
        .sort();
      saveFolders(folders.filter(f => f !== "Favorites" && f !== "Uncategorized"));

      const query = searchInput.value.toLowerCase();
      const selectedFolder = folderFilter.value;
      let saved = all.filter(i => i.text);

      switch (sortBy.value) {
        case "oldest": saved.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); break;
        case "name": saved.sort((a, b) => a.text.localeCompare(b.text)); break;
        case "favorite": saved.sort((a, b) => (b.favorite || 0) - (a.favorite || 0)); break;
        default: saved.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); break;
      }

      container.innerHTML = "";

      folders.forEach(folder => {
        const items = folder === "Favorites"
          ? saved.filter(i => i.favorite)
          : saved.filter(i => (i.folder || "Uncategorized") === folder);

        const section = document.createElement("div");
        section.className = "border-t pt-4 folder-section";
        section.dataset.folder = folder;

        const header = document.createElement("h2");
        header.className = `text-lg font-semibold ${folder === "Favorites" ? 'text-yellow-600' : 'text-blue-600'} mb-2 folder-toggle`;
        header.textContent = `üìÅ ${folder}`;
        header.addEventListener("click", () => toggleSection(folder));
        section.appendChild(header);

        const itemsWrapper = document.createElement("div");
        itemsWrapper.className = "folder-items hidden";

        if (items.length === 0) {
          const emptyNote = document.createElement("div");
          emptyNote.className = "text-sm text-gray-400 italic mb-2";
          emptyNote.textContent = "No items in this folder yet.";
          itemsWrapper.appendChild(emptyNote);
        } else {
          items.forEach((item, idx) => {
            const div = document.createElement("div");
            div.className = "p-4 bg-gray-100 rounded shadow-sm relative mb-2";

            const folderDropdown = document.createElement("select");
            folderDropdown.className = "border rounded text-sm px-2 py-1 mt-1";
            getFolders().concat(["Uncategorized"]).forEach(f => {
              const opt = document.createElement("option");
              opt.value = f;
              opt.textContent = f;
              if ((item.folder || "Uncategorized") === f) opt.selected = true;
              folderDropdown.appendChild(opt);
            });

            folderDropdown.addEventListener("change", (e) => {
              const updatedFolder = e.target.value;
              const all = JSON.parse(localStorage.getItem("library") || "[]");
              const originalIndex = all.findIndex(x => x.timestamp === item.timestamp);
              if (originalIndex > -1) {
                all[originalIndex].folder = updatedFolder;
                localStorage.setItem("library", JSON.stringify(all));
                loadLibrary();
              }
            });

            div.innerHTML = `
              <div class="flex justify-between items-start">
                <div class="text-sm text-gray-600">Saved: ${new Date(item.timestamp).toLocaleString()}</div>
                <div class="flex gap-2">
                  <button onclick="toggleFavorite('${item.timestamp}')" class="text-yellow-500 text-lg">${item.favorite ? '‚òÖ' : '‚òÜ'}</button>
                  <button onclick="deleteItem(${idx})" class="text-red-500 text-xs underline">Delete</button>
                </div>
              </div>
              <pre class="whitespace-pre-wrap text-sm my-2">${item.text}</pre>
            `;
            div.appendChild(folderDropdown);
            itemsWrapper.appendChild(div);
          });
        }

        section.appendChild(itemsWrapper);
        container.appendChild(section);
      });

      // Re-open folders that were previously open
      openFolders.forEach(folderId => {
        const section = document.querySelector(`div[data-folder='${folderId}'] .folder-items`);
        if (section) section.classList.remove("hidden");
      });
    }

    function deleteItem(index) {
      const saved = JSON.parse(localStorage.getItem("library") || "[]");
      saved.splice(index, 1);
      localStorage.setItem("library", JSON.stringify(saved));
      loadLibrary();
    }

    function toggleFavorite(timestamp) {
      const saved = JSON.parse(localStorage.getItem("library") || "[]");
      const i = saved.findIndex(item => item.timestamp === timestamp);
      if (i > -1) {
        saved[i].favorite = !saved[i].favorite;
        localStorage.setItem("library", JSON.stringify(saved));
        loadLibrary();
      }
    }

    function populateFilters() {
      const folders = getFolders().concat(["Uncategorized", "Favorites"]);
      folderFilter.innerHTML = '<option value="">All Folders</option>' +
        folders.map(folder => `<option value="${folder}">${folder}</option>`).join('');
    }

    document.getElementById("deleteFolderBtn").addEventListener("click", () => {
      const folderToDelete = folderFilter.value;
      if (!folderToDelete || folderToDelete === "Favorites") return alert("Select a valid folder to delete.");
      if (confirm(`Are you sure you want to delete the folder "${folderToDelete}"? Items will move to 'Uncategorized'.`)) {
        let folders = getFolders().filter(f => f !== folderToDelete);
        saveFolders(folders);
        const saved = JSON.parse(localStorage.getItem("library") || "[]");
        saved.forEach(item => {
          if (item.folder === folderToDelete) item.folder = "Uncategorized";
        });
        localStorage.setItem("library", JSON.stringify(saved));
        populateFilters();
        loadLibrary();
      }
    });

    createFolderBtn.addEventListener("click", () => {
      const folderName = newFolderInput.value.trim();
      if (!folderName) return alert("Enter a folder name.");
      const folders = getFolders();
      if (!folders.includes(folderName)) {
        folders.push(folderName);
        saveFolders(folders);
        populateFilters();
        loadLibrary();
      }
      newFolderInput.value = "";
    });

    document.getElementById("clearLibrary").addEventListener("click", () => {
      if (confirm("Clear all saved items?")) {
        localStorage.removeItem("library");
        loadLibrary();
        populateFilters();
      }
    });

    searchInput.addEventListener("input", loadLibrary);
    folderFilter.addEventListener("change", loadLibrary);
    sortBy.addEventListener("change", loadLibrary);

    populateFilters();
    loadLibrary();

    // Automatically open the "Uncategorized" folder on load
    setTimeout(() => {
      openFolders.add("Uncategorized");
      loadLibrary();
    }, 50);
  </script>
</body>
</html>
