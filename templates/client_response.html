{% extends "base.html" %}
{% block title %}Client Response Assistant{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-6 mt-6">
  <h1 class="text-2xl font-bold text-blue-800 mb-2">ğŸ’¬ Client Response Assistant</h1>
  <p class="text-gray-700 text-sm mb-4">Use this tool to turn client questions, concerns, or objections into professional, on-brand responses.</p>

  <div class="mb-4">
    <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ’¬ Or choose a common question to start:</label>
    <div id="exampleContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
  </div>

  <div class="flex items-center gap-2 mb-2">
    <textarea id="clientMessage" rows="3" placeholder="Paste client message or click ğŸ™" class="w-full border rounded p-2 text-sm"></textarea>
    <button id="micClientBtn" class="text-xl" title="Click to speak">ğŸ™ï¸</button>
  </div>

  <select id="templateTone" class="w-full border rounded px-3 py-2 mb-2">
    <option value="">Default</option>
    <option value="Friendly">Friendly</option>
    <option value="Direct">Direct</option>
    <option value="Reassuring">Reassuring</option>
    <option value="Professional">Professional</option>
  </select>

  <button id="generateReplyBtn" class="btn btn-primary w-full mb-2">âœ¨ Generate Smart Reply</button>

  <div id="clientLoadingSpinner" class="hidden text-indigo-600 text-sm animate-pulse mb-2">â³ Generating reply...</div>
  <div id="clientReplyLockedMsg" class="hidden text-sm text-red-600 mb-2">
    ğŸ”’ Free smart reply used. <button onclick="goPro()" class="underline">Upgrade to Pro</button>
  </div>

  <pre id="clientReplyOutput" class="bg-white border border-gray-200 rounded-2xl p-5 mb-2 text-base text-gray-800 font-sans leading-7 shadow-sm whitespace-pre-wrap max-h-72 overflow-y-auto"></pre>

  <div class="flex gap-2 mb-4">
    <button id="copyBtn" class="btn-mini">ğŸ“‹ Copy</button>

    <button id="saveBtn" class="btn-mini">ğŸ’¾ Save</button>
    <button id="regenerateClientReplyBtn" class="btn btn-primary">ğŸ” Regenerate</button>
  </div>
</div>

<script>
  const EXAMPLES = [
    "Weâ€™re nervous about interest rates going up.",
    "Weâ€™re thinking of waiting until next year to buy.",
    "Can we find something under $200k still?",
    "We already have an agent but might switch.",
    "Weâ€™re just browsing for now, not serious yet.",
    "Weâ€™re relocating and unsure about timing.",
    "Do we need 20% down to buy?",
    "Is the market going to crash soon?",
    "How much is my home worth now?",
    "Whatâ€™s your commission rate?",
    "Weâ€™re worried about overpaying.",
    "Weâ€™re first-time buyers and nervous.",
    "Weâ€™re selling and buying at the same time.",
    "Can we buy before we sell?",
    "Do we need to stage our home to sell?",
    "Whatâ€™s happening with interest rates?",
    "Should we wait until spring to list?",
    "Weâ€™re not ready yet, just exploring.",
    "Do we need pre-approval first?",
    "We want to see homes but aren't sure yet."
  ];

  const generateExamples = () => {
    const container = document.getElementById("exampleContainer");
    EXAMPLES.forEach(text => {
      const btn = document.createElement("button");
      btn.className = "btn btn-secondary text-left w-full";
      btn.textContent = text;
      btn.onclick = () => document.getElementById("clientMessage").value = text;
      container.appendChild(btn);
    });
  };

  document.addEventListener("DOMContentLoaded", async () => {
    generateExamples();

    const generateBtn = document.getElementById("generateReplyBtn");
    const outputBox = document.getElementById("clientReplyOutput");
    const loadingSpinner = document.getElementById("clientLoadingSpinner");
    const lockedMsg = document.getElementById("clientReplyLockedMsg");
    const regenerateBtn = document.getElementById("regenerateClientReplyBtn");
    const saveBtn = document.getElementById("saveBtn");
    const usageCounter = document.getElementById("usageCounter");
    const badge = document.getElementById("userStatusBadge");
    const toneSelect = document.getElementById("templateTone");
    const messageInput = document.getElementById("clientMessage");
    const subBtn = document.getElementById("subscribeBtn");
    const copyBtn = document.getElementById("copyBtn");

    let lastGenerated = "";
    let isPro = false;

    const updateUsage = (usage) => {
      if (!usage) return;
      usageCounter.classList.remove("hidden");
      usageCounter.textContent = `Usage: ${usage.count} of ${usage.limit}`;
    };

    try {
      const res = await fetch("/api/user-status");
      const data = await res.json();
      isPro = data.isPro;
      if (isPro) {
        badge.textContent = "Pro User";
        badge.classList.add("bg-green-100", "text-green-800");
      } else {
        badge.textContent = "Free User";
        badge.classList.add("bg-yellow-100", "text-yellow-800");
        updateUsage(data.usage);
      }
    } catch {
      badge.textContent = "âš ï¸ Error";
    }

    generateBtn.addEventListener("click", async () => {
      const msg = messageInput.value.trim();
      const tone = toneSelect.value.trim() || "Professional";
      if (!msg) return alert("Paste a client message first.");

      outputBox.innerText = "";
      lockedMsg.classList.add("hidden");
      loadingSpinner.classList.remove("hidden");

      try {
        const res = await fetch("/draft-client-reply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg, tone })
        });
        const data = await res.json();
        loadingSpinner.classList.add("hidden");

        if (data.error) {
          outputBox.innerText = data.error;
          lockedMsg.classList.remove("hidden");
          updateUsage(data.usage);
          return;
        }

        const cleaned = data.result
          .replace(/As an AI[^.]*\./gi, '')
          .replace(/I'm an AI[^.]*\./gi, '')
          .trim();

        lastGenerated = cleaned;
        outputBox.innerText = cleaned;
        updateUsage(data.usage);
      } catch (err) {
        loadingSpinner.classList.add("hidden");
        outputBox.innerText = "âš ï¸ Something went wrong.";
      }
    });

    regenerateBtn.addEventListener("click", async () => {
      if (!lastGenerated) return;

      outputBox.innerText = "";
      loadingSpinner.classList.remove("hidden");

      try {
        const res = await fetch("/regenerate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ last_output: lastGenerated })
        });
        const data = await res.json();
        loadingSpinner.classList.add("hidden");

        if (data.error) {
          outputBox.innerText = data.error;
          lockedMsg.classList.remove("hidden");
          updateUsage(data.usage);
          return;
        }

        const cleaned = data.output
          .replace(/As an AI[^.]*\./gi, '')
          .replace(/I'm an AI[^.]*\./gi, '')
          .trim();

        lastGenerated = cleaned;
        outputBox.innerText = cleaned;
        updateUsage(data.usage);
      } catch (err) {
        loadingSpinner.classList.add("hidden");
        outputBox.innerText = "âš ï¸ Something went wrong.";
      }
    });

    saveBtn.addEventListener("click", () => {
      const text = outputBox.textContent.trim();
      if (!text) return alert("No reply to save.");
      const saved = JSON.parse(localStorage.getItem("library") || "[]");
      saved.push({ text, timestamp: new Date().toISOString() });
      localStorage.setItem("library", JSON.stringify(saved));
      alert("Saved to library!");
    });

    copyBtn.addEventListener("click", () => {
      const text = outputBox.textContent.trim();
      if (!text) return alert("Nothing to copy!");
      navigator.clipboard.writeText(text).then(() => {
        copyBtn.textContent = "âœ… Copied!";
        setTimeout(() => copyBtn.textContent = "ğŸ“‹ Copy", 2000);
      });
    });

    if (subBtn) {
      subBtn.addEventListener("click", async () => {
        subBtn.textContent = "Redirecting...";
        try {
          const res = await fetch("/subscribe", { method: "POST" });
          const data = await res.json();
          if (data.url) {
            window.location.href = data.url;
          } else {
            alert("Subscription error. Try again.");
            subBtn.textContent = "Subscribe to Pro";
          }
        } catch (err) {
          alert("Subscription error.");
          subBtn.textContent = "Subscribe to Pro";
        }
      });
    }
  });

  function goPro() {
    window.location.href = "/subscribe";
  }
</script>
{% endblock %}
